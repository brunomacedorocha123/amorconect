<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verificar E-mail - Amor Conect</title>
    
    <!-- CSS ORGANIZADO -->
    <link rel="stylesheet" href="styles-base.css">
    <link rel="stylesheet" href="styles-componentes.css">
    <link rel="stylesheet" href="styles-pages.css">
</head>
<body class="verification-page">
    <!-- Header -->
    <header>
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <img src="assets/images/logoamorconect.png" alt="Amor Conect">
                    <h1>Amor Conect</h1>
                </div>
                
                <div class="auth-buttons">
                    <a href="login.html" class="btn btn-outline">Entrar</a>
                    <a href="cadastro.html" class="btn btn-primary">Cadastre-se</a>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <div class="container">
            <div class="verification-container">
                <div class="verification-header">
                    <div class="verification-icon">üìß</div>
                    <h2>Verifique seu E-mail</h2>
                    <p>Enviamos um link de verifica√ß√£o para seu e-mail</p>
                </div>

                <div class="verification-body">
                    <!-- Estados da verifica√ß√£o -->
                    <div class="verification-state" id="autoVerification">
                        <div class="loading">
                            <div class="spinner"></div>
                            <p>Verificando automaticamente...</p>
                        </div>
                    </div>

                    <div class="verification-state" id="manualVerification" style="display: none;">
                        <div class="verification-info">
                            <p>‚ö†Ô∏è <strong>Verifica√ß√£o autom√°tica falhou</strong></p>
                            <p>Copie o token do e-mail e cole abaixo:</p>
                        </div>
                        
                        <div class="form-group">
                            <input type="text" id="tokenInput" class="form-control" placeholder="Cole o token aqui" required>
                            <div class="error-message" id="tokenError">Por favor, cole o token do e-mail</div>
                        </div>
                        
                        <button class="btn btn-primary btn-block" onclick="verificationPage.verifyManual()">
                            Verificar E-mail
                        </button>
                    </div>

                    <div class="verification-state" id="successVerification" style="display: none;">
                        <div class="verification-success">
                            <div class="success-icon">‚úÖ</div>
                            <h3>E-mail Verificado com Sucesso!</h3>
                            <p>Sua conta foi ativada. Agora voc√™ pode fazer login e come√ßar a usar o Amor Conect.</p>
                            <a href="login.html?verified=true" class="btn btn-primary btn-large">
                                Fazer Login
                            </a>
                        </div>
                    </div>

                    <div class="verification-state" id="errorVerification" style="display: none;">
                        <div class="verification-error">
                            <div class="error-icon">‚ùå</div>
                            <h3>Erro na Verifica√ß√£o</h3>
                            <p id="errorMessage">Ocorreu um erro ao verificar seu e-mail.</p>
                            <div class="verification-actions">
                                <button class="btn btn-secondary" onclick="verificationPage.retryAutoVerification()">
                                    Tentar Novamente
                                </button>
                                <a href="cadastro.html" class="btn btn-outline">
                                    Voltar ao Cadastro
                                </a>
                            </div>
                        </div>
                    </div>

                    <!-- Informa√ß√µes adicionais -->
                    <div class="verification-help">
                        <h4>Precisa de ajuda?</h4>
                        <ul>
                            <li>üì© Verifique sua pasta de spam/lixo eletr√¥nico</li>
                            <li>‚è∞ O link expira em 24 horas</li>
                            <li>üîÅ N√£o recebeu? <a href="#" onclick="verificationPage.resendEmail()">Reenviar e-mail</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="footer-column">
                    <h3>Amor Conect</h3>
                    <p>Uma plataforma segura e discreta para conectar cora√ß√µes e construir relacionamentos genu√≠nos.</p>
                </div>
                <div class="footer-column">
                    <h3>Links R√°pidos</h3>
                    <ul>
                        <li><a href="index.html">P√°gina Inicial</a></li>
                        <li><a href="#como-funciona">Como Funciona</a></li>
                        <li><a href="#depoimentos">Depoimentos</a></li>
                    </ul>
                </div>
                <div class="footer-column">
                    <h3>Suporte</h3>
                    <ul>
                        <li><a href="#">Central de Ajuda</a></li>
                        <li><a href="#">Pol√≠tica de Privacidade</a></li>
                        <li><a href="#">Termos de Uso</a></li>
                    </ul>
                </div>
            </div>
            <div class="copyright">
                <p>&copy; 2024 Amor Conect. Todos os direitos reservados.</p>
            </div>
        </div>
    </footer>

    <!-- JavaScript Organizado -->
    <script type="module">
        import { authService } from './scripts/auth-service.js'
        import { funcaoUtilitario } from './scripts/funcao-utilitario.js'

        class VerificationPage {
            constructor() {
                this.init()
            }

            async init() {
                this.setupEventListeners()
                await this.attemptAutoVerification()
                
                console.log('‚úÖ P√°gina de verifica√ß√£o inicializada')
            }

            // Configurar event listeners
            setupEventListeners() {
                // Enter key no input do token
                document.getElementById('tokenInput')?.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        this.verifyManual()
                    }
                })

                // Verificar se h√° par√¢metros de e-mail na URL
                this.checkEmailParameter()
            }

            // Verificar par√¢metro de e-mail na URL
            checkEmailParameter() {
                const urlParams = new URLSearchParams(window.location.search)
                const email = urlParams.get('email')
                
                if (email) {
                    console.log('üìß E-mail para verifica√ß√£o:', email)
                    // Voc√™ pode usar isso para personalizar a mensagem ou reenvio
                }
            }

            // Mostrar estado espec√≠fico
            showState(stateId) {
                const states = ['autoVerification', 'manualVerification', 'successVerification', 'errorVerification']
                states.forEach(state => {
                    const element = document.getElementById(state)
                    if (element) {
                        element.style.display = state === stateId ? 'block' : 'none'
                    }
                })
            }

            // Tentar verifica√ß√£o autom√°tica
            async attemptAutoVerification() {
                console.log('üîÑ Tentando verifica√ß√£o autom√°tica...')
                
                // Extrair token da URL (Supabase usa hash fragments)
                const urlParams = new URLSearchParams(window.location.hash.substring(1))
                const accessToken = urlParams.get('access_token')
                const type = urlParams.get('type')
                
                if (accessToken && type === 'email') {
                    try {
                        const { data, error } = await authService.verifyEmail(accessToken)
                        
                        if (error) {
                            console.error('‚ùå Erro na verifica√ß√£o autom√°tica:', error)
                            throw error
                        }
                        
                        console.log('‚úÖ Verifica√ß√£o autom√°tica bem-sucedida:', data)
                        this.showSuccess()
                        
                    } catch (error) {
                        console.error('‚ùå Falha na verifica√ß√£o autom√°tica:', error)
                        this.showManualVerification(error.message)
                    }
                } else {
                    console.log('‚ÑπÔ∏è Nenhum token encontrado na URL, mostrando verifica√ß√£o manual')
                    this.showManualVerification()
                }
            }

            // Tentar novamente a verifica√ß√£o autom√°tica
            async retryAutoVerification() {
                this.showState('autoVerification')
                await this.attemptAutoVerification()
            }

            // Mostrar verifica√ß√£o manual
            showManualVerification(errorMessage = '') {
                this.showState('manualVerification')
                
                if (errorMessage) {
                    console.log('‚ÑπÔ∏è Mostrando verifica√ß√£o manual devido a:', errorMessage)
                }
            }

            // Mostrar sucesso
            showSuccess() {
                this.showState('successVerification')
                
                // Limpar URL
                window.history.replaceState({}, document.title, window.location.pathname)
            }

            // Mostrar erro
            showError(message) {
                this.showState('errorVerification')
                document.getElementById('errorMessage').textContent = message
            }

            // Verifica√ß√£o manual
            async verifyManual() {
                const tokenInput = document.getElementById('tokenInput')
                const token = tokenInput.value.trim()
                
                if (!token) {
                    this.showError('tokenError', 'Por favor, cole o token do e-mail')
                    tokenInput.classList.add('error')
                    return
                }

                this.hideError('tokenError')
                tokenInput.classList.remove('error')
                this.showState('autoVerification')

                try {
                    console.log('üîÑ Verificando token manual...')
                    
                    const { data, error } = await authService.verifyEmail(token)
                    
                    if (error) {
                        console.error('‚ùå Erro na verifica√ß√£o manual:', error)
                        throw error
                    }
                    
                    console.log('‚úÖ Verifica√ß√£o manual bem-sucedida:', data)
                    this.showSuccess()
                    
                } catch (error) {
                    console.error('‚ùå Falha na verifica√ß√£o manual:', error)
                    this.showError('Token inv√°lido ou expirado. Tente novamente ou solicite um novo e-mail.')
                }
            }

            // Reenviar e-mail de verifica√ß√£o
            async resendEmail() {
                const urlParams = new URLSearchParams(window.location.search)
                const email = urlParams.get('email')
                
                if (!email) {
                    funcaoUtilitario.mostrarAlerta('N√£o foi poss√≠vel identificar o e-mail para reenvio.', 'erro')
                    return
                }

                try {
                    console.log('üîÑ Reenviando e-mail para:', email)
                    
                    // Aqui voc√™ precisaria implementar a fun√ß√£o de reenvio no auth-service
                    // Por enquanto, vamos mostrar uma mensagem informativa
                    funcaoUtilitario.mostrarAlerta(
                        `E-mail de verifica√ß√£o reenviado para ${email}. Verifique sua caixa de entrada.`, 
                        'sucesso'
                    )
                    
                } catch (error) {
                    console.error('‚ùå Erro ao reenviar e-mail:', error)
                    funcaoUtilitario.mostrarAlerta('Erro ao reenviar e-mail. Tente novamente.', 'erro')
                }
            }

            // Mostrar erro espec√≠fico
            showError(elementId, message) {
                const errorElement = document.getElementById(elementId)
                if (errorElement) {
                    errorElement.textContent = message
                    errorElement.style.display = 'block'
                }
            }

            // Esconder erro
            hideError(elementId) {
                const errorElement = document.getElementById(elementId)
                if (errorElement) {
                    errorElement.style.display = 'none'
                }
            }
        }

        // Criar inst√¢ncia global para acesso via onclick
        const verificationPage = new VerificationPage()

        // Inicializar quando o DOM carregar
        document.addEventListener('DOMContentLoaded', () => {
            // A inst√¢ncia j√° √© criada acima, mas garantimos a inicializa√ß√£o
            console.log('üîê P√°gina de verifica√ß√£o carregada')
        })

    </script>
</body>
</html>
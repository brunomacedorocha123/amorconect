<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home - Amor Conect</title>
    
    <!-- CSS ORGANIZADO -->
    <link rel="stylesheet" href="styles-base.css">
    <link rel="stylesheet" href="styles-componentes.css">
    <link rel="stylesheet" href="styles-pages.css">
</head>
<body>
    <!-- Header -->
    <header>
        <div class="container">
            <div class="header-content">
                <!-- Bot√£o Hamburguer -->
                <button id="hamburgerBtn">‚ò∞</button>
                
                <!-- Logo -->
                <div class="logo">
                    <img src="assets/images/logoamorconect.png" alt="Amor Conect">
                </div>
                
                <!-- Menu Desktop -->
                <div class="user-menu">
                    <div class="user-info">
                        <div class="user-avatar" id="userAvatar">
                            <img class="user-avatar-img" src="" alt="Avatar" style="display: none;">
                            <div class="user-avatar-fallback">U</div>
                        </div>
                        <span id="userNickname">Usu√°rio</span>
                    </div>
                    
                    <!-- Badge Free e Bot√£o Premium -->
                    <div id="freeBadge" class="free-badge" style="display: none;">Free</div>
                    <a href="princing.html" id="premiumBtn" class="btn btn-premium" style="display: none;">Premium</a>
                    
                    <a href="mensagens.html" class="btn btn-outline">Mensagens</a>
                    <a href="busca.html" class="btn btn-outline">Buscar</a>
                    <a href="painel.html" class="btn btn-outline">Perfil</a>
                    <a href="blocks.html" class="btn btn-outline">üö´ Bloqueados</a>
                    <button class="btn btn-outline" id="logoutBtn">Sair</button>
                </div>
            </div>
        </div>
    </header>

    <!-- Menu Mobile -->
    <div id="mobileMenu">
        <button id="closeMobileMenu">√ó</button>
        
        <div class="mobile-user-info">
            <div class="user-avatar" id="mobileUserAvatar">
                <img class="user-avatar-img" src="" alt="Avatar" style="display: none;">
                <div class="user-avatar-fallback">U</div>
            </div>
            <div id="mobileUserNickname">Usu√°rio</div>
        </div>

        <div class="mobile-nav">
            <!-- Badge Free e Bot√£o Premium Mobile -->
            <div id="mobileFreeBadge" class="free-badge" style="display: none;">Free</div>
            <a href="princing.html" id="mobilePremiumBtn" class="btn btn-premium" style="display: none;">Premium</a>
            
            <a href="busca.html" class="btn btn-outline">Buscar</a>
            <a href="painel.html" class="btn btn-outline">Perfil</a>
            <a href="mensagens.html" class="btn btn-outline">Mensagens</a>
            <a href="blocks.html" class="btn btn-outline">üö´ Bloqueados</a>
            <button class="btn btn-outline" id="mobileLogoutBtn">Sair</button>
        </div>
    </div>

    <!-- Main Content -->
    <main class="main-content">
        <div class="container">
            <!-- Welcome Section -->
            <section class="welcome-section">
                <h2>Ol√°, <span id="welcomeNickname">Amoroso</span>! ‚ù§Ô∏è</h2>
                <p>Encontre conex√µes genu√≠nas e construa relacionamentos significativos</p>
                <div style="margin-top: 1.5rem;">
                    <a href="princing.html" class="btn btn-premium" style="padding: 0.8rem 2rem; font-size: 1rem;">
                        Desbloqueie Recursos Premium
                    </a>
                </div>
            </section>

            <!-- User Stats -->
            <div class="user-stats">
                <div class="stat-card">
                    <div class="stat-number" id="usersOnline">0</div>
                    <div class="stat-label">Pessoas Online</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalUsers">0</div>
                    <div class="stat-label">Usu√°rios na Plataforma</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="newMatches">0</div>
                    <div class="stat-label">Novos Matches</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="profileViews">0</div>
                    <div class="stat-label">Visualiza√ß√µes do Perfil</div>
                </div>
            </div>

            <!-- Visitantes Section -->
            <section class="visitors-section">
                <div class="visitors-card">
                    <div class="visitors-header">
                        <h2>üëÄ Quem te visitou</h2>
                        <div class="visitors-count" id="visitorsCount">0 visitas</div>
                    </div>

                    <!-- Conte√∫do Premium -->
                    <div class="premium-content" id="premiumVisitors" style="display: none;">
                        <div class="visitors-grid" id="visitorsGrid">
                            <div class="visitors-loading">
                                <div class="visitors-spinner"></div>
                                <p>Carregando visitantes...</p>
                            </div>
                        </div>
                        
                        <div class="visitors-actions">
                            <button class="btn btn-primary" onclick="window.location.href='visitante.html'">
                                Ver todos os visitantes
                            </button>
                        </div>
                    </div>

                    <!-- Conte√∫do Free -->
                    <div class="free-content" id="freeVisitors">
                        <div class="icon">üîí</div>
                        <h3>Descubra quem se interessou por voc√™!</h3>
                        <p>
                            <span id="freeVisitorsCount">0 pessoas</span> visitaram seu perfil esta semana
                        </p>
                        <a href="princing.html" class="btn btn-premium">
                            Seja Premium para ver
                        </a>
                    </div>
                </div>
            </section>

            <!-- Users Grid -->
            <section class="users-section">
                <div class="section-header">
                    <h2>Conhe√ßa Novas Pessoas</h2>
                    <a href="princing.html" class="btn btn-premium btn-sm">Premium</a>
                </div>
                <div class="users-grid" id="usersGrid">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Carregando usu√°rios...</p>
                    </div>
                </div>
            </section>

            <!-- Quick Actions -->
            <section class="quick-actions">
                <h2>A√ß√µes R√°pidas</h2>
                <div class="actions-grid">
                    <a href="painel.html" class="action-card">
                        <div class="action-icon">üë§</div>
                        <h3>Completar Perfil</h3>
                        <p>Adicione mais informa√ß√µes ao seu perfil</p>
                    </a>
                    <a href="busca.html" class="action-card">
                        <div class="action-icon">üîç</div>
                        <h3>Buscar Pessoas</h3>
                        <p>Encontre pessoas com interesses similares</p>
                    </a>
                    <a href="mensagens.html" class="action-card">
                        <div class="action-icon">üíå</div>
                        <h3>Minhas Mensagens</h3>
                        <p>Ver e responder mensagens</p>
                    </a>
                    <a href="blocks.html" class="action-card" style="background: linear-gradient(135deg, #fed7d7, #feb2b2); border: 2px solid #e53e3e;">
                        <div class="action-icon">üö´</div>
                        <h3>Usu√°rios Bloqueados</h3>
                        <p>Gerencie usu√°rios que voc√™ bloqueou</p>
                    </a>
                    <a href="princing.html" class="action-card" style="background: linear-gradient(135deg, #fff9c4, #ffecb3); border: 2px solid #ffd700;">
                        <div class="action-icon">‚≠ê</div>
                        <h3>Plano Premium</h3>
                        <p>Desbloqueie recursos exclusivos</p>
                    </a>
                </div>
            </section>
        </div>
    </main>

    <!-- Footer -->
    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="footer-column">
                    <h3>Amor Conect</h3>
                    <p>Uma plataforma segura e discreta para conectar cora√ß√µes e construir relacionamentos genu√≠nos.</p>
                </div>
                <div class="footer-column">
                    <h3>Links R√°pidos</h3>
                    <ul>
                        <li><a href="index.html">P√°gina Inicial</a></li>
                        <li><a href="princing.html">Planos Premium</a></li>
                        <li><a href="#como-funciona">Como Funciona</a></li>
                        <li><a href="#depoimentos">Depoimentos</a></li>
                    </ul>
                </div>
                <div class="footer-column">
                    <h3>Suporte</h3>
                    <ul>
                        <li><a href="#">Central de Ajuda</a></li>
                        <li><a href="#">Pol√≠tica de Privacidade</a></li>
                        <li><a href="#">Termos de Uso</a></li>
                        <li><a href="#" onclick="openSupportModal()">üö® Reportar Problema</a></li>
                    </ul>
                </div>
            </div>
            <div class="copyright">
                <p>&copy; 2024 Amor Conect. Todos os direitos reservados.</p>
            </div>
        </div>
    </footer>

    <!-- JavaScript Organizado -->
    <script type="module">
        // Importar servi√ßos
        import { authService } from './scripts/auth-service.js'
        import { usersService } from './scripts/users-service.js'
        import { visitanteService } from './scripts/visitante-service.js'
        import { blockService } from './scripts/block-service.js'
        import { funcaoUtilitario } from './scripts/funcao-utilitario.js'
        import { menuHamburguer } from './scripts/menu-hamburguer.js'

        // Estado da aplica√ß√£o
        let currentUser = null
        let userProfile = null

        // Inicializar aplica√ß√£o
        async function inicializarApp() {
            try {
                console.log('üöÄ Inicializando aplica√ß√£o...')
                
                // 1. Verificar autentica√ß√£o
                currentUser = await authService.checkAuth()
                if (!currentUser) return
                
                // 2. Carregar perfil do usu√°rio
                userProfile = await authService.getUserProfile(currentUser.id)
                
                // 3. Atualizar UI do usu√°rio
                await atualizarUIUsuario()
                
                // 4. Carregar dados em paralelo
                await Promise.all([
                    carregarEstatisticas(),
                    carregarUsuarios(),
                    carregarVisitantes()
                ])
                
                // 5. Inicializar sistemas
                await blockService.initializeBlockSystem(currentUser.id)
                authService.updateOnlineStatus(currentUser.id)
                
                // 6. Iniciar atualiza√ß√µes autom√°ticas
                iniciarAtualizacoesAutomaticas()
                
                console.log('‚úÖ Aplica√ß√£o inicializada com sucesso!')
                
            } catch (error) {
                console.error('‚ùå Erro ao inicializar aplica√ß√£o:', error)
                funcaoUtilitario.mostrarAlerta('Erro ao carregar a p√°gina', 'erro')
            }
        }

        // Atualizar UI do usu√°rio
        async function atualizarUIUsuario() {
            try {
                let displayName = 'Usu√°rio'
                
                if (currentUser.user_metadata?.nickname) {
                    displayName = currentUser.user_metadata.nickname
                } else if (currentUser.user_metadata?.full_name) {
                    displayName = currentUser.user_metadata.full_name
                } else if (currentUser.email) {
                    displayName = currentUser.email.split('@')[0]
                }

                // Atualizar nomes
                document.getElementById('userNickname').textContent = displayName
                document.getElementById('mobileUserNickname').textContent = displayName
                document.getElementById('welcomeNickname').textContent = displayName

                // Atualizar avatares
                await usersService.updateUserAvatar(displayName, userProfile, document.getElementById('userAvatar'))
                await usersService.updateUserAvatar(displayName, userProfile, document.getElementById('mobileUserAvatar'))

                // Atualizar premium status
                const isPremium = userProfile?.is_premium || false
                atualizarUIPremium(isPremium)
                
            } catch (error) {
                console.error('‚ùå Erro ao atualizar UI do usu√°rio:', error)
            }
        }

        // Atualizar UI Premium/Free
        function atualizarUIPremium(isPremium) {
            const freeBadge = document.getElementById('freeBadge')
            const premiumBtn = document.getElementById('premiumBtn')
            const mobileFreeBadge = document.getElementById('mobileFreeBadge')
            const mobilePremiumBtn = document.getElementById('mobilePremiumBtn')
            
            if (isPremium) {
                if (premiumBtn) premiumBtn.style.display = 'inline-block'
                if (freeBadge) freeBadge.style.display = 'none'
                if (mobilePremiumBtn) mobilePremiumBtn.style.display = 'flex'
                if (mobileFreeBadge) mobileFreeBadge.style.display = 'none'
            } else {
                if (freeBadge) freeBadge.style.display = 'inline-block'
                if (premiumBtn) premiumBtn.style.display = 'none'
                if (mobileFreeBadge) mobileFreeBadge.style.display = 'flex'
                if (mobilePremiumBtn) mobilePremiumBtn.style.display = 'none'
            }
        }

        // Carregar estat√≠sticas
        async function carregarEstatisticas() {
            try {
                const stats = await usersService.getStats(currentUser.id)
                
                document.getElementById('usersOnline').textContent = stats.onlineUsers
                document.getElementById('totalUsers').textContent = stats.totalUsers
                document.getElementById('newMatches').textContent = stats.newMessages
                document.getElementById('profileViews').textContent = stats.profileViews
                
            } catch (error) {
                console.error('‚ùå Erro ao carregar estat√≠sticas:', error)
            }
        }

        // Carregar usu√°rios
        async function carregarUsuarios() {
            try {
                const users = await usersService.loadHomeUsers(currentUser.id)
                const usersGrid = document.getElementById('usersGrid')
                
                if (users.length === 0) {
                    usersGrid.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">üë•</div>
                            <h3>Nenhum usu√°rio encontrado</h3>
                            <p>Ainda n√£o h√° outros usu√°rios cadastrados</p>
                            <button class="btn btn-primary" onclick="window.location.href='busca.html'">
                                üîç Ir para Busca
                            </button>
                        </div>
                    `
                    return
                }
                
                let usersHTML = ''
                for (const user of users) {
                    const cardHTML = await usersService.createUserCard(user, currentUser.id)
                    usersHTML += cardHTML
                }
                
                usersGrid.innerHTML = usersHTML
                
            } catch (error) {
                console.error('‚ùå Erro ao carregar usu√°rios:', error)
                document.getElementById('usersGrid').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">‚ùå</div>
                        <h3>Erro ao carregar usu√°rios</h3>
                        <p>Tente recarregar a p√°gina</p>
                    </div>
                `
            }
        }

        // Carregar visitantes
        async function carregarVisitantes() {
            try {
                await visitanteService.updateVisitorsUI(currentUser.id)
            } catch (error) {
                console.error('‚ùå Erro ao carregar visitantes:', error)
            }
        }

        // Iniciar atualiza√ß√µes autom√°ticas
        function iniciarAtualizacoesAutomaticas() {
            // Atualizar status online a cada minuto
            setInterval(() => {
                if (currentUser) {
                    authService.updateOnlineStatus(currentUser.id)
                }
            }, 60000)
            
            // Atualizar estat√≠sticas a cada 30 segundos
            setInterval(() => {
                if (currentUser) {
                    carregarEstatisticas()
                }
            }, 30000)
        }

        // Event Listeners
        document.getElementById('logoutBtn')?.addEventListener('click', authService.logout)
        document.getElementById('mobileLogoutBtn')?.addEventListener('click', authService.logout)

        // Inicializar
        inicializarApp()

        // Exportar fun√ß√µes globais para os cards
        window.usersService = usersService
        window.visitanteService = visitanteService
        window.blockService = blockService

    </script>
</body>
</html>
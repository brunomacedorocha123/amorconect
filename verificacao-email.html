<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verificar E-mail - Amor Conect</title>
    
    <!-- CSS -->
    <link rel="stylesheet" href="globals.css">
    <link rel="stylesheet" href="components.css">
    
    <style>
        /* Estilos espec√≠ficos da verifica√ß√£o */
        body {
            background: linear-gradient(135deg, var(--vermelho-rosado), var(--lilas));
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }

        .verification-container {
            background: var(--branco);
            padding: 3rem;
            border-radius: 20px;
            box-shadow: var(--shadow-xl);
            max-width: 500px;
            width: 100%;
            text-align: center;
            border: 1px solid var(--lilas);
            position: relative;
            overflow: hidden;
        }

        .verification-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(135deg, var(--vermelho-rosado), var(--lilas));
        }

        .verification-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {
                transform: translateY(0);
            }
            40% {
                transform: translateY(-10px);
            }
            60% {
                transform: translateY(-5px);
            }
        }

        h1 {
            color: var(--vermelho-rosado);
            margin-bottom: 1rem;
            font-size: 2.2rem;
        }

        .email-display {
            background: var(--bege);
            padding: 1rem;
            border-radius: 10px;
            margin: 1.5rem 0;
            font-weight: bold;
            color: var(--vermelho-rosado);
            border: 1px solid var(--lilas);
            word-break: break-all;
        }

        .instructions {
            text-align: left;
            background: var(--cinza-claro);
            padding: 1.5rem;
            border-radius: 10px;
            margin: 1.5rem 0;
            border-left: 4px solid var(--vermelho-rosado);
        }

        .instructions h3 {
            color: var(--vermelho-rosado);
            margin-bottom: 1rem;
            font-size: 1.1rem;
        }

        .instructions ol {
            margin-left: 1.5rem;
            color: var(--preto);
        }

        .instructions li {
            margin-bottom: 0.5rem;
            line-height: 1.5;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--bege);
            border-top: 4px solid var(--vermelho-rosado);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 1rem auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .resend-section {
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 1px solid var(--lilas);
        }

        .countdown {
            font-size: 0.9rem;
            color: var(--cinza-escuro);
            margin-top: 0.5rem;
        }

        .manual-verification {
            background: var(--bege);
            padding: 1.5rem;
            border-radius: 10px;
            margin: 1.5rem 0;
            border: 1px solid var(--lilas);
            text-align: left;
        }

        .token-input {
            width: 100%;
            padding: 1rem;
            margin: 1rem 0;
            border: 2px solid var(--lilas);
            border-radius: 10px;
            font-size: 1rem;
            font-family: inherit;
            transition: var(--transition);
        }

        .token-input:focus {
            outline: none;
            border-color: var(--vermelho-rosado);
            box-shadow: 0 0 0 3px rgba(233, 30, 99, 0.1);
        }

        .btn-block {
            width: 100%;
            margin: 0.5rem 0;
        }

        @media (max-width: 768px) {
            .verification-container {
                padding: 2rem;
                margin: 1rem;
            }

            h1 {
                font-size: 1.8rem;
            }

            .verification-icon {
                font-size: 3rem;
            }
        }

        @media (max-width: 480px) {
            .verification-container {
                padding: 1.5rem;
            }

            h1 {
                font-size: 1.6rem;
            }

            .instructions {
                padding: 1rem;
            }
        }
    </style>
</head>
<body>
    <div class="verification-container">
        <div class="verification-icon">üìß</div>
        <h1>Verifica√ß√£o de E-mail</h1>
        
        <!-- Mensagem Inicial -->
        <div id="initialMessage">
            <p>Enviamos um link de confirma√ß√£o para:</p>
            <div id="emailDisplay" class="email-display">carregando...</div>
            <p>Clique no link do e-mail para ativar sua conta.</p>
        </div>

        <!-- Instru√ß√µes -->
        <div class="instructions">
            <h3>üìã N√£o recebeu o e-mail?</h3>
            <ol>
                <li>Verifique sua <strong>pasta de spam</strong> ou <strong>lixo eletr√¥nico</strong></li>
                <li>Certifique-se de que digitou o e-mail corretamente</li>
                <li>Aguarde alguns minutos - pode levar at√© 5 minutos para chegar</li>
                <li>Se ainda n√£o recebeu, clique em "Reenviar E-mail" abaixo</li>
            </ol>
        </div>

        <!-- Verifica√ß√£o Autom√°tica -->
        <div id="autoVerification" style="display: none;">
            <p>Verificando automaticamente...</p>
            <div class="spinner"></div>
        </div>
        
        <!-- Verifica√ß√£o Manual -->
        <div id="manualVerification" style="display: none;">
            <div class="manual-verification">
                <p><strong>‚ö†Ô∏è Verifica√ß√£o autom√°tica falhou</strong></p>
                <p>Se voc√™ recebeu um token por e-mail, cole-o abaixo:</p>
                <input type="text" id="tokenInput" placeholder="Cole o token aqui (opcional)" class="token-input">
                <button class="btn btn-primary btn-block" onclick="verifyManual()">Verificar E-mail</button>
            </div>
        </div>
        
        <!-- Mensagens de Status -->
        <div id="successMessage" class="alert alert-success" style="display: none;">
            <h3>‚úÖ E-mail Verificado!</h3>
            <p>Sua conta foi ativada com sucesso!</p>
            <a href="login.html" class="btn btn-primary btn-block">Fazer Login</a>
        </div>
        
        <div id="errorMessage" class="alert alert-error" style="display: none;"></div>

        <!-- Se√ß√£o de Reenvio -->
        <div class="resend-section">
            <p>N√£o recebeu o e-mail de confirma√ß√£o?</p>
            <button class="btn btn-outline btn-block" onclick="resendConfirmation()" id="resendBtn">
                üîÑ Reenviar E-mail
            </button>
            <div id="countdown" class="countdown"></div>
        </div>

        <!-- Voltar ao Cadastro -->
        <div style="margin-top: 2rem; padding-top: 1rem; border-top: 1px solid var(--lilas);">
            <p>Digitou o e-mail errado?</p>
            <a href="cadastro.html" class="btn btn-secondary btn-block">‚Ü©Ô∏è Voltar ao Cadastro</a>
        </div>
    </div>

    <script src="globals.js"></script>
    
    <script>
        // ==================== VERIFICA√á√ÉO DE E-MAIL ====================
        
        let userEmail = '';
        let resendCooldown = 60; // 60 segundos de cooldown
        let resendTimer = null;

        // Inicializar p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üìß P√°gina de verifica√ß√£o inicializada');
            
            // Obter email da URL
            const urlParams = new URLSearchParams(window.location.search);
            userEmail = urlParams.get('email');
            
            if (userEmail) {
                document.getElementById('emailDisplay').textContent = userEmail;
                // Salvar email no localStorage para recupera√ß√£o
                localStorage.setItem('pendingVerificationEmail', userEmail);
            } else {
                // Tentar recuperar do localStorage
                userEmail = localStorage.getItem('pendingVerificationEmail');
                if (userEmail) {
                    document.getElementById('emailDisplay').textContent = userEmail;
                } else {
                    document.getElementById('emailDisplay').textContent = 'N√£o identificado';
                }
            }
            
            // Iniciar verifica√ß√£o autom√°tica
            attemptAutoVerification();
            
            // Iniciar contador de reenvio
            startResendCooldown();
        });

        // Tentar verifica√ß√£o autom√°tica pela URL
        async function attemptAutoVerification() {
            const urlParams = new URLSearchParams(window.location.hash.substring(1));
            const accessToken = urlParams.get('access_token');
            const type = urlParams.get('type');
            
            if (accessToken && type === 'email') {
                console.log('üîÑ Tentando verifica√ß√£o autom√°tica...');
                
                document.getElementById('initialMessage').style.display = 'none';
                document.getElementById('autoVerification').style.display = 'block';
                
                try {
                    const { data, error } = await supabase.auth.verifyOtp({
                        token_hash: accessToken,
                        type: 'email'
                    });
                    
                    if (error) throw error;
                    
                    // ‚úÖ SUCESSO
                    console.log('‚úÖ E-mail verificado com sucesso!');
                    showSuccess();
                    
                    // Limpar URL e localStorage
                    window.history.replaceState({}, document.title, window.location.pathname);
                    localStorage.removeItem('pendingVerificationEmail');
                    
                } catch (error) {
                    console.error('‚ùå Erro verifica√ß√£o autom√°tica:', error);
                    showManualVerification();
                }
            }
        }

        function showManualVerification() {
            document.getElementById('autoVerification').style.display = 'none';
            document.getElementById('manualVerification').style.display = 'block';
        }

        async function verifyManual() {
            const token = document.getElementById('tokenInput').value.trim();
            
            if (!token) {
                showError('Por favor, cole o token do e-mail ou aguarde a verifica√ß√£o autom√°tica.');
                return;
            }
            
            const verifyBtn = document.querySelector('#manualVerification .btn');
            const originalText = verifyBtn.innerHTML;
            verifyBtn.innerHTML = '<div class="spinner" style="width: 20px; height: 20px; margin: 0 auto;"></div> Verificando...';
            verifyBtn.disabled = true;
            
            try {
                const { data, error } = await supabase.auth.verifyOtp({
                    token_hash: token,
                    type: 'email'
                });
                
                if (error) throw error;
                
                document.getElementById('manualVerification').style.display = 'none';
                showSuccess();
                
                // Limpar localStorage
                localStorage.removeItem('pendingVerificationEmail');
                
            } catch (error) {
                console.error('‚ùå Erro na verifica√ß√£o manual:', error);
                showError('Token inv√°lido ou expirado. Tente novamente ou solicite um novo e-mail.');
            } finally {
                verifyBtn.innerHTML = originalText;
                verifyBtn.disabled = false;
            }
        }

        async function resendConfirmation() {
            if (!userEmail) {
                showError('E-mail n√£o identificado. Volte √† p√°gina de cadastro.');
                return;
            }
            
            const resendBtn = document.getElementById('resendBtn');
            resendBtn.disabled = true;
            resendBtn.innerHTML = 'üì® Enviando...';
            
            try {
                const { error } = await supabase.auth.resend({
                    type: 'signup',
                    email: userEmail,
                    options: {
                        emailRedirectTo: `${window.location.origin}/verificacao-email.html`
                    }
                });
                
                if (error) throw error;
                
                showSuccess('‚úÖ E-mail de confirma√ß√£o reenviado! Verifique sua caixa de entrada.');
                
                // Reiniciar cooldown
                startResendCooldown();
                
            } catch (error) {
                console.error('‚ùå Erro ao reenviar confirma√ß√£o:', error);
                showError('Erro ao reenviar e-mail: ' + error.message);
                resendBtn.disabled = false;
                resendBtn.innerHTML = 'üîÑ Reenviar E-mail';
            }
        }

        function startResendCooldown() {
            clearInterval(resendTimer);
            resendCooldown = 60;
            
            const resendBtn = document.getElementById('resendBtn');
            const countdown = document.getElementById('countdown');
            
            resendBtn.disabled = true;
            
            resendTimer = setInterval(() => {
                resendCooldown--;
                
                if (resendCooldown <= 0) {
                    clearInterval(resendTimer);
                    resendBtn.disabled = false;
                    resendBtn.innerHTML = 'üîÑ Reenviar E-mail';
                    countdown.textContent = '';
                } else {
                    resendBtn.innerHTML = `‚è≥ ${resendCooldown}s`;
                    countdown.textContent = `Aguarde ${resendCooldown} segundos para reenviar`;
                }
            }, 1000);
        }

        function showSuccess(message) {
            if (!message) {
                document.getElementById('initialMessage').style.display = 'none';
                document.getElementById('autoVerification').style.display = 'none';
                document.getElementById('manualVerification').style.display = 'none';
                document.getElementById('successMessage').style.display = 'block';
            } else {
                showError(message, 'success');
            }
        }

        function showError(message, type = 'error') {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.className = type === 'success' ? 'alert alert-success' : 'alert alert-error';
            errorDiv.style.display = 'block';
            
            // Scroll para o erro
            errorDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            
            // Auto-esconder ap√≥s 5 segundos para mensagens de sucesso
            if (type === 'success') {
                setTimeout(() => {
                    errorDiv.style.display = 'none';
                }, 5000);
            }
        }

        // Verificar se o usu√°rio j√° est√° logado (email j√° confirmado)
        async function checkIfAlreadyVerified() {
            try {
                const { data: { user } } = await supabase.auth.getUser();
                if (user && user.email_confirmed_at) {
                    showSuccess();
                }
            } catch (error) {
                console.error('Erro ao verificar status:', error);
            }
        }

        // Verificar a cada 10 segundos se o email foi confirmado
        setInterval(checkIfAlreadyVerified, 10000);
    </script>
</body>
</html>